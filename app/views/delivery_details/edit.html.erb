<%= render "shared/navbar" %>

<div class="delivery-form-container"
     data-controller="delivery">

  <h2>âœï¸ Modifier mes informations de livraison / retrait</h2>

  <% if @delivery_detail.errors.any? %>
    <div class="form-errors">
      <strong>Le formulaire contient <%= @delivery_detail.errors.count %> erreur(s) :</strong>
      <ul>
        <% @delivery_detail.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with model: [@order, @delivery_detail],
                local: true,
                data: { turbo: false } do |f| %>

    <!-- ğŸ” MODE -->
    <div class="form-group">
      <%= f.label :mode, "Mode de rÃ©ception" %>
      <%= f.select :mode,
            [["ğŸšš Livraison", "delivery"], ["ğŸ› Retrait en boutique", "pickup"]],
            {},
            class: "form-control",
            data: {
              delivery_target: "modeSelect",
              action: "change->delivery#toggleMode"
            } %>
    </div>

    <!-- ğŸ“… DATE -->
    <div class="form-group">
      <%= f.label :date, "Date souhaitÃ©e" %>
      <%= f.text_field :date,
            class: "form-control",
            data: { controller: "datepicker" } %>
    </div>

    <!-- ğŸ•“ CRÃ‰NEAU -->
    <div class="form-group">
      <%= f.label :time_slot, "CrÃ©neau horaire" %>
      <%= f.select :time_slot,
            [["ğŸŒ Matin (9h-12h30)", "morning"],
             ["ğŸŒ† AprÃ¨s-midi (14h-19h)", "afternoon"]],
            {},
            class: "form-control" %>
    </div>

    <!-- ğŸ“§ EMAIL (obligatoire tous les cas) -->
    <div class="form-group">
      <%= f.label :recipient_email, "Email de contact" %>
      <%= f.email_field :recipient_email,
            class: "form-control",
            required: true,
            autocomplete: "email" %>
    </div>

    <!-- ğŸ“ TÃ‰LÃ‰PHONE (obligatoire tous les cas) -->
    <div class="form-group">
      <%= f.label :recipient_phone, "TÃ©lÃ©phone de contact" %>
      <%= f.telephone_field :recipient_phone,
            class: "form-control",
            required: true %>
    </div>

    <!-- ğŸšš LIVRAISON -->
    <div data-delivery-target="deliveryFields"
         class="delivery-section <%= @delivery_detail.pickup? ? "hidden" : "" %>">

      <h3>ğŸšš Informations de livraison</h3>

      <div class="form-group">
        <%= f.label :recipient_name, "Nom du destinataire" %>
        <%= f.text_field :recipient_name, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :recipient_firstname, "PrÃ©nom du destinataire" %>
        <%= f.text_field :recipient_firstname, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :recipient_address, "Adresse" %>
        <%= f.text_field :recipient_address, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :recipient_city, "Ville" %>
        <%= f.select :recipient_city,
              DeliveryDetail::VILLAGES.map { |v| [v, v] },
              { prompt: "SÃ©lectionnez une ville" },
              class: "form-control" %>
      </div>

      <%# ğŸ•Šï¸ DEUIL : uniquement si commande concernÃ©e %>
      <% if @order.products.any? { |p| p.category == "deuil" } %>
        <hr>
        <h4>Informations de cÃ©rÃ©monie</h4>

        <div class="form-group">
          <%= f.label :ceremony_date, "Date de la cÃ©rÃ©monie" %>
          <%= f.date_field :ceremony_date, class: "form-control" %>
        </div>

        <div class="form-group">
          <%= f.label :ceremony_time, "Heure de la cÃ©rÃ©monie" %>
          <%= f.time_field :ceremony_time, class: "form-control" %>
        </div>

        <div class="form-group">
          <%= f.label :ceremony_location, "Lieu (Ã©glise ou cimetiÃ¨re)" %>
          <%= f.text_field :ceremony_location, class: "form-control" %>
        </div>
      <% end %>
    </div>

    <!-- ğŸ› RETRAIT -->
    <div data-delivery-target="pickupFields"
         class="pickup-section <%= @delivery_detail.delivery? ? "hidden" : "" %>">

      <h3>ğŸ› Retrait en boutique</h3>
      <p class="info">
        ğŸ•‘ Merci de prÃ©voir un dÃ©lai minimum de <strong>2 heures</strong> avant retrait.
      </p>
    </div>

    <!-- ğŸ“ NOTES -->
    <div class="form-group">
      <%= f.label :notes, "Notes particuliÃ¨res (optionnel)" %>
      <%= f.text_area :notes, rows: 3, class: "form-control" %>
    </div>

    <!-- âœ… ACTIONS -->
    <div class="form-actions">
      <%= f.submit "ğŸ’¾ Mettre Ã  jour",
            class: "btn btn-primary" %>

      <%= link_to "â†©ï¸ Retour au panier",
            checkout_order_path(@order),
            class: "btn btn-secondary" %>
    </div>

  <% end %>
</div>
