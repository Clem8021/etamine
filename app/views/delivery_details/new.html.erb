<div class="floating-back-button">
  <%= link_to root_path, class: "back-link" do %>
    <span>←</span>
    <%= image_tag "logo.png", alt: "Logo Etamine", class: "logo-small" %>
  <% end %>
</div>

<% current_step =
     if current_page?(checkout_order_path(@order))
       1
     elsif current_page?(new_order_delivery_detail_path(@order)) ||
           (@order.delivery_detail&.persisted? &&
            current_page?(edit_order_delivery_detail_path(@order, @order.delivery_detail)))
       2
     elsif current_page?(confirm_order_path(@order))
       3
     else
       0
     end %>

<div class="checkout-progress">
  <div class="step <%= 'completed' if current_step > 1 %> <%= 'active' if current_step == 1 %>">
    <span class="circle">1</span>
    <span class="label">Panier</span>
  </div>

  <div class="connector <%= 'filled' if current_step > 1 %>"></div>

  <div class="step <%= 'completed' if current_step > 2 %> <%= 'active' if current_step == 2 %>">
    <span class="circle">2</span>
    <span class="label">Livraison</span>
  </div>

  <div class="connector <%= 'filled' if current_step > 2 %>"></div>

  <div class="step <%= 'active' if current_step == 3 %>">
    <span class="circle">3</span>
    <span class="label">Paiement</span>
  </div>
</div>

<h2>Informations de livraison / retrait</h2>

<!-- 📌 Encadré d'infos -->
<div class="delivery-notice">
  <ul>
    <li><strong>🛍 Retrait magasin :</strong> délai minimum <strong>2h</strong>.</li>
    <li><strong>🚚 Livraison :</strong> pas de commande en ligne pour le <strong>jour J</strong> — appelez la boutique si besoin.</li>
    <li><strong>💶 Frais de livraison :</strong>
      Gratuit sur <strong>Flesselles</strong> dès 20€,
      <strong>3,50€</strong> hors Flesselles.
    </li>
  </ul>
</div>

<!-- ✅ Formulaire principal -->
<%= form_with model: [@order, @delivery_detail],
              local: true,
              data: { turbo: false, controller: "delivery" },
              class: "delivery-form" do |f| %>

  <!-- 🕹️ Choix du mode -->
  <div class="form-group">
    <%= f.label :mode, "Mode de réception" %><br>
    <%= f.select :mode,
                 [["🛍 Retrait en boutique", "pickup"], ["🚚 Livraison", "delivery"]],
                 { prompt: "Sélectionnez un mode" },
                 data: { action: "change->delivery#toggleMode" },
                 class: "form-control" %>
  </div>

  <!-- 📅 Date (Flatpickr) -->
  <div class="form-group">
    <%= f.label :date, "Date" %><br>
    <%= f.text_field :date,
          class: "form-control",
          data: { controller: "datepicker" } %>
    <small class="form-hint">📅 Le lundi et le jour même ne sont pas disponibles.</small>
  </div>

  <!-- 🕓 Créneaux horaires -->
  <div class="form-group">
    <%= f.label :time_slot, "Créneau horaire" %><br>
    <%= f.select :time_slot,
                 [["🌞 Matin (9h-12h30)", "morning"], ["🌆 Après-midi (14h-19h)", "afternoon"]],
                 { prompt: "Sélectionnez un créneau" },
                 class: "form-control" %>
  </div>

  <!-- 🚚 SECTION LIVRAISON -->
  <div id="delivery-fields" class="hidden delivery-section" data-delivery-target="deliveryFields">
    <h3>🚚 Informations de livraison</h3>

    <div class="form-group">
      <%= f.label :recipient_name, "Nom du destinataire" %><br>
      <%= f.text_field :recipient_name, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_firstname, "Prénom du destinataire" %><br>
      <%= f.text_field :recipient_firstname, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_address, "Adresse" %><br>
      <%= f.text_field :recipient_address, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_zip, "Code postal" %><br>
      <%= f.text_field :recipient_zip, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_city, "Ville" %><br>
      <%= f.select :recipient_city,
                   DeliveryDetail::VILLAGES.map { |v| [v, v] },
                   { prompt: "Sélectionnez une ville" },
                   class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_phone, "Téléphone du destinataire" %><br>
      <%= f.telephone_field :recipient_phone, class: "form-control" %>
    </div>
  </div>

  <!-- 🕊️ Si produit de deuil -->
  <% if @order.products.any? { |p| p.category == "deuil" } %>
    <div class="form-group">
      <%= f.label :ceremony_date, "Date de la cérémonie" %>
      <%= f.date_field :ceremony_date, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :ceremony_time, "Heure de la cérémonie" %>
      <%= f.time_field :ceremony_time, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :ceremony_location, "Lieu (église ou cimetière)" %>
      <%= f.text_field :ceremony_location, class: "form-control" %>
    </div>
  <% end %>

  <!-- 🛍 SECTION RETRAIT -->
  <div id="pickup-fields" class="hidden pickup-section" data-delivery-target="pickupFields">
    <h3>🛍 Informations pour le retrait</h3>
    <p>Merci de venir chercher votre commande à l’horaire choisi.</p>
    <p><em>Délai minimum de 2h entre commande et retrait.</em></p>
  </div>

  <!-- 📝 Notes -->
  <div class="form-group">
    <%= f.label :notes, "Notes (optionnel)" %><br>
    <%= f.text_area :notes, rows: 3, class: "form-control" %>
  </div>

  <!-- ✅ Bouton -->
  <div class="form-actions">
    <%= f.submit "💳 Valider et passer au paiement", class: "btn btn-primary" %>
  </div>
<% end %>
