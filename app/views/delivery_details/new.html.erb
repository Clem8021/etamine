<div class="floating-back-button">
  <%= link_to root_path, class: "back-link" do %>
    <span>â†</span>
    <%= image_tag "logo.png", alt: "Logo Etamine", class: "logo-small" %>
  <% end %>
</div>

<% current_step =
     if current_page?(checkout_order_path(@order))
       1
     elsif current_page?(new_order_delivery_detail_path(@order)) ||
           (@order.delivery_detail&.persisted? &&
            current_page?(edit_order_delivery_detail_path(@order, @order.delivery_detail)))
       2
     elsif current_page?(confirm_order_path(@order))
       3
     else
       0
     end %>

<div class="checkout-progress">
  <div class="step <%= 'completed' if current_step > 1 %> <%= 'active' if current_step == 1 %>">
    <span class="circle">1</span>
    <span class="label">Panier</span>
  </div>

  <div class="connector <%= 'filled' if current_step > 1 %>"></div>

  <div class="step <%= 'completed' if current_step > 2 %> <%= 'active' if current_step == 2 %>">
    <span class="circle">2</span>
    <span class="label">Livraison</span>
  </div>

  <div class="connector <%= 'filled' if current_step > 2 %>"></div>

  <div class="step <%= 'active' if current_step == 3 %>">
    <span class="circle">3</span>
    <span class="label">Paiement</span>
  </div>
</div>

<h2>Informations de livraison / retrait</h2>

<!-- ğŸ“Œ EncadrÃ© d'infos -->
<div class="delivery-notice">
  <ul>
    <li><strong>ğŸ› Retrait magasin :</strong> dÃ©lai minimum <strong>2h</strong>.</li>
    <li><strong>ğŸšš Livraison :</strong> pas de commande en ligne pour le <strong>jour J</strong> â€” appelez la boutique si besoin.</li>
    <li><strong>ğŸ’¶ Frais de livraison :</strong>
      Gratuit sur <strong>Flesselles</strong> dÃ¨s 20â‚¬,
      <strong>3,50â‚¬</strong> hors Flesselles.
    </li>
  </ul>
</div>

<!-- âœ… Formulaire principal -->
<%= form_with model: [@order, @delivery_detail],
              local: true,
              data: { turbo: false, controller: "delivery" },
              class: "delivery-form" do |f| %>

  <!-- ğŸ•¹ï¸ Choix du mode -->
  <div class="form-group">
    <%= f.label :mode, "Mode de rÃ©ception" %><br>
    <%= f.select :mode,
                 [["ğŸ› Retrait en boutique", "pickup"], ["ğŸšš Livraison", "delivery"]],
                 { prompt: "SÃ©lectionnez un mode" },
                 data: { action: "change->delivery#toggleMode" },
                 class: "form-control" %>
  </div>

  <!-- ğŸ“… Date (Flatpickr) -->
  <div class="form-group">
    <%= f.label :date, "Date" %><br>
    <%= f.text_field :date,
          class: "form-control",
          data: { controller: "datepicker" } %>
    <small class="form-hint">ğŸ“… Le lundi et le jour mÃªme ne sont pas disponibles.</small>
  </div>

  <!-- ğŸ•“ CrÃ©neaux horaires -->
  <div class="form-group">
    <%= f.label :time_slot, "CrÃ©neau horaire" %><br>
    <%= f.select :time_slot,
                 [["ğŸŒ Matin (9h-12h30)", "morning"], ["ğŸŒ† AprÃ¨s-midi (14h-19h)", "afternoon"]],
                 { prompt: "SÃ©lectionnez un crÃ©neau" },
                 class: "form-control" %>
  </div>

  <!-- ğŸšš SECTION LIVRAISON -->
  <div id="delivery-fields" class="hidden delivery-section" data-delivery-target="deliveryFields">
    <h3>ğŸšš Informations de livraison</h3>

    <div class="form-group">
      <%= f.label :recipient_name, "Nom du destinataire" %><br>
      <%= f.text_field :recipient_name, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_firstname, "PrÃ©nom du destinataire" %><br>
      <%= f.text_field :recipient_firstname, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_address, "Adresse" %><br>
      <%= f.text_field :recipient_address, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_zip, "Code postal" %><br>
      <%= f.text_field :recipient_zip, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_city, "Ville" %><br>
      <%= f.select :recipient_city,
                   DeliveryDetail::VILLAGES.map { |v| [v, v] },
                   { prompt: "SÃ©lectionnez une ville" },
                   class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :recipient_phone, "TÃ©lÃ©phone du destinataire" %><br>
      <%= f.telephone_field :recipient_phone, class: "form-control" %>
    </div>
  </div>

  <!-- ğŸ•Šï¸ Si produit de deuil -->
  <% if @order.products.any? { |p| p.category == "deuil" } %>
    <div class="form-group">
      <%= f.label :ceremony_date, "Date de la cÃ©rÃ©monie" %>
      <%= f.date_field :ceremony_date, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :ceremony_time, "Heure de la cÃ©rÃ©monie" %>
      <%= f.time_field :ceremony_time, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :ceremony_location, "Lieu (Ã©glise ou cimetiÃ¨re)" %>
      <%= f.text_field :ceremony_location, class: "form-control" %>
    </div>
  <% end %>

  <!-- ğŸ› SECTION RETRAIT -->
  <div id="pickup-fields" class="hidden pickup-section" data-delivery-target="pickupFields">
    <h3>ğŸ› Informations pour le retrait</h3>
    <p>Merci de venir chercher votre commande Ã  lâ€™horaire choisi.</p>
    <p><em>DÃ©lai minimum de 2h entre commande et retrait.</em></p>
  </div>

  <!-- ğŸ“ Notes -->
  <div class="form-group">
    <%= f.label :notes, "Notes (optionnel)" %><br>
    <%= f.text_area :notes, rows: 3, class: "form-control" %>
  </div>

  <!-- âœ… Bouton -->
  <div class="form-actions">
    <%= f.submit "ğŸ’³ Valider et passer au paiement", class: "btn btn-primary" %>
  </div>
<% end %>
