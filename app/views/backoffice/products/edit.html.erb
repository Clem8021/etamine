<%= render "shared/navbar" %>

<div class="admin-container">
  <header class="admin-header">
    <h1 class="admin-title">Modifier le produit</h1>
    <p class="admin-subtitle">
      <strong><%= @product.name %></strong>
      <span class="muted">— <%= Product.category_label(@product.category) %></span>
    </p>

    <div style="margin-top: 12px; display:flex; gap:10px; flex-wrap:wrap;">
      <%= link_to "← Retour aux produits", backoffice_products_path, class: "btn btn-outline" %>

      <% if @product.respond_to?(:active) %>
        <%= button_to (@product.active ? "Désactiver" : "Activer"),
              toggle_active_backoffice_product_path(@product),
              method: :patch,
              class: "btn #{ @product.active ? 'btn-danger' : 'btn-primary' }" %>
        <%= button_to "Supprimer",
              backoffice_product_path(@product),
              method: :delete,
              data: {
                turbo_confirm: "⚠️ Supprimer définitivement ce produit ? Cette action est irréversible."
              },
              class: "btn btn-danger" %>
      <% end %>
    </div>
  </header>

  <div class="admin-grid">
    <div class="admin-card-panel">
      <h2 class="admin-card-title">Informations produit</h2>
      <p class="admin-card-subtitle">Modifie les champs puis enregistre.</p>

      <%= render "form", product: @product %>
    </div>

    <aside class="admin-card-panel">
      <h2 class="admin-card-title">Aperçu</h2>

      <div class="admin-image-preview">
        <div class="muted" style="margin-bottom: 8px;">Aperçu image</div>

        <%= image_tag(
              (@product.photo.attached? ? url_for(@product.photo) : @product.display_image_url),
              id: "product-image-preview",
              class: "admin-product-image",
              data: {
                fallback: asset_path("placeholder.jpg"),
                assets_prefix: Rails.application.config.assets.prefix
              }
            ) %>
      </div>

      <div class="admin-preview-row" style="margin-top: 12px;">
        <span class="muted">Catégorie</span>
        <span class="badge badge-pickup"><%= Product.category_label(@product.category) %></span>
      </div>

      <%# ... garde le reste de ton "Aperçu rapide" ici ... %>
    </aside>
  </div>
</div>

<script>
  document.addEventListener("turbo:load", () => {
    const urlInput  = document.getElementById("product_image_url");
    const fileInput = document.getElementById("product_photo");
    const img       = document.getElementById("product-image-preview");
    if (!img) return;

    const fallback = img.dataset.fallback;
    const assetsPrefix = img.dataset.assetsPrefix || "/assets";

    const setSrcFromUrl = (value) => {
      const v = (value || "").trim();
      if (!v) return (img.src = fallback);

      if (v.startsWith("http://") || v.startsWith("https://") || v.startsWith("/")) {
        img.src = v;
      } else {
        img.src = `${assetsPrefix}/${v}`;
      }
    };

    const setSrcFromFile = (file) => {
      if (!file) return;
      if (!file.type || !file.type.startsWith("image/")) return;

      const objectUrl = URL.createObjectURL(file);
      img.src = objectUrl;
      img.onload = () => URL.revokeObjectURL(objectUrl);
    };

    // Init depuis image_url si présent
    if (urlInput) setSrcFromUrl(urlInput.value);

    // Live update URL
    if (urlInput) urlInput.addEventListener("input", () => setSrcFromUrl(urlInput.value));

    // Live preview upload
    if (fileInput) fileInput.addEventListener("change", () => setSrcFromFile(fileInput.files[0]));

    img.addEventListener("error", () => { img.src = fallback; });
  });
</script>
