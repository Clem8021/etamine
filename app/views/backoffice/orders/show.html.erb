<%= render "shared/navbar" %>

<div class="admin-container">
  <h1 class="admin-title">Commande nÂ°<%= @order.id %></h1>

  <!-- ğŸ‘¤ CLIENT -->
  <section class="admin-card">
    <h2>ğŸ‘¤ Client</h2>
    <p><strong>Nom :</strong> <%= @order.full_name.presence || "â€”" %></p>
    <p><strong>Email :</strong> <%= @order.email.presence || "â€”" %></p>
    <p><strong>TÃ©lÃ©phone :</strong> <%= @order.phone_number.presence || "â€”" %></p>

    <p class="muted">
      <strong>CrÃ©Ã©e :</strong>
      <%= l(@order.created_at.in_time_zone("Europe/Paris"), format: :long) rescue @order.created_at %>
    </p>
  </section>

  <!-- ğŸšš LIVRAISON / RETRAIT -->
  <section class="admin-card">
    <h2>ğŸšš Livraison / Retrait</h2>

    <% if @order.delivery_detail.present? %>
      <% delivery = @order.delivery_detail %>

      <div class="admin-info-grid">
        <div>
          <p>
            <strong>Mode :</strong>
            <%= delivery.mode == "delivery" ? "ğŸšš Livraison" : "ğŸª Retrait en boutique" %>
          </p>

          <p>
            <strong>Date :</strong>
            <%= delivery.date.present? ? l(delivery.date, format: :long) : "â€”" %>
          </p>

          <p>
            <strong>CrÃ©neau :</strong>
            <%= case delivery.time_slot
                when "morning" then "Matin (9h â€“ 12h30)"
                when "afternoon" then "AprÃ¨s-midi (14h â€“ 19h)"
                else delivery.time_slot.presence || "â€”"
                end %>
          </p>
        </div>

        <div>
          <p><strong>Email :</strong> <%= delivery.recipient_email.presence || "â€”" %></p>
          <p><strong>TÃ©lÃ©phone :</strong> <%= delivery.recipient_phone.presence || "â€”" %></p>
        </div>
      </div>

      <% if delivery.mode == "delivery" %>
        <hr>

        <h3>ğŸ  Adresse de livraison</h3>
        <p>
          <strong>Destinataire :</strong>
          <%= [delivery.recipient_firstname, delivery.recipient_name].compact.join(" ").presence || "â€”" %>
        </p>
        <p><strong>Adresse :</strong> <%= delivery.recipient_address.presence || "â€”" %></p>
        <p><strong>Code postal :</strong> <%= delivery.recipient_zip.presence || "â€”" %></p>
        <p><strong>Ville :</strong> <%= delivery.recipient_city.presence || "â€”" %></p>
      <% end %>

      <% if delivery.notes.present? %>
        <hr>
        <h3>ğŸ“ Notes</h3>
        <p><%= simple_format(delivery.notes) %></p>
      <% end %>

      <% if @order.products.any? { |p| p.category == "deuil" } %>
        <hr>
        <h3>ğŸ•Šï¸ CÃ©rÃ©monie (deuil)</h3>
        <p><strong>Date :</strong> <%= delivery.ceremony_date.present? ? l(delivery.ceremony_date) : "â€”" %></p>
        <p><strong>Heure :</strong> <%= delivery.ceremony_time.presence || "â€”" %></p>
        <p><strong>Lieu :</strong> <%= delivery.ceremony_location.presence || "â€”" %></p>
      <% end %>

    <% else %>
      <p class="muted">âš ï¸ Aucune information de livraison enregistrÃ©e.</p>
    <% end %>
  </section>

  <!-- ğŸ› ARTICLES -->
  <section class="admin-card">
    <h2>ğŸ› Articles</h2>

    <ul class="admin-items">
      <% @order.order_items.includes(:product).each do |item| %>

        <% addons_array =
          case item.addons
          when Array then item.addons
          when String then item.addons.split(",").map(&:strip)
          else []
          end
        %>

        <%# On retire seulement les libellÃ©s exacts qu'on affiche ailleurs %>
        <% cleaned_addons = addons_array.reject { |a|
          s = a.to_s.downcase.strip
          s == "carte message" || s.include?("ruban")
        } %>

        <%# Textes carte / ruban (multi-compat) %>
        <% card_text  = item.try(:addon_card_text).presence || item.try(:message_text).presence %>
        <% ruban_text = item.try(:addon_ruban_text).presence || item.try(:ribbon_text).presence %>

        <% line_total = (item.price_cents.to_i * item.quantity.to_i) / 100.0 %>

        <li class="admin-item">
          <div class="admin-item-main">
            <div>
              <div class="admin-item-title"><%= item.product.name %></div>

              <div class="admin-item-meta">
                <% if item.size.present? %>
                  <div><span class="muted">Option :</span> <%= item.size %></div>
                <% end %>

                <% if item.respond_to?(:color) && item.color.present? %>
                  <div><span class="muted">Couleur :</span> <%= item.color %></div>
                <% end %>

                <% if cleaned_addons.any? %>
                  <div><span class="muted">Options :</span> <%= cleaned_addons.join(", ") %></div>
                <% end %>
              </div>

              <%# ğŸ´ Carte message %>
              <% if (item.respond_to?(:addon_card) && item.addon_card) || card_text.present? %>
                <div class="admin-addon">
                  <div class="admin-addon-label">ğŸ´ Carte message</div>
                  <div class="admin-addon-box">
                    <%= card_text.present? ? simple_format(card_text) : "Oui (sans texte)" %>
                  </div>
                </div>
              <% end %>

              <%# ğŸ—ï¸ Ruban %>
              <% if (item.respond_to?(:addon_ruban) && item.addon_ruban) || ruban_text.present? %>
                <div class="admin-addon">
                  <div class="admin-addon-label">ğŸ—ï¸ Ruban</div>
                  <div class="admin-addon-box">
                    <%= ruban_text.present? ? simple_format(ruban_text) : "Oui (sans texte)" %>
                  </div>
                </div>
              <% end %>

              <%# Ancienne nomenclature Ã©ventuelle (fallback) %>
              <% if item.try(:addon_type).present? || item.try(:addon_text).present? %>
                <div class="admin-addon">
                  <div class="admin-addon-label">ğŸ—‚ï¸ Carte (ancien champ)</div>
                  <div class="admin-addon-box">
                    <%= simple_format([item.try(:addon_type), item.try(:addon_text)].compact.join(" â€” ")) %>
                  </div>
                </div>
              <% end %>
            </div>

            <div class="admin-item-price">
              <div><strong><%= item.quantity %> Ã—</strong></div>
              <div><%= number_to_currency(item.price_cents.to_i / 100.0, unit: "â‚¬") %></div>
              <div class="muted">Total : <%= number_to_currency(line_total, unit: "â‚¬") %></div>
            </div>
          </div>
        </li>
      <% end %>
    </ul>
  </section>

  <%= link_to "â† Retour aux commandes", backoffice_orders_path, class: "btn btn-outline" %>
</div>
