<%= render "shared/navbar" %>

<div class="admin-container">
  <h1 class="admin-title">Commande nÂ°<%= @order.id %></h1>

  <!-- ğŸ‘¤ CLIENT -->
  <section class="admin-card">
    <h2>ğŸ‘¤ Client</h2>
    <p><strong>Nom :</strong> <%= @order.full_name.presence || "â€”" %></p>
    <p><strong>Email :</strong> <%= @order.email.presence || "â€”" %></p>
    <p><strong>TÃ©lÃ©phone :</strong> <%= @order.phone_number.presence || "â€”" %></p>
  </section>

  <!-- ğŸšš LIVRAISON / RETRAIT -->
  <section class="admin-card">
    <h2>ğŸšš Livraison / Retrait</h2>

    <% if @order.delivery_detail.present? %>
      <% delivery = @order.delivery_detail %>

      <p>
        <strong>Mode :</strong>
        <%= delivery.mode == "delivery" ? "ğŸšš Livraison" : "ğŸª Retrait en boutique" %>
      </p>

      <p><strong>Date :</strong> <%= l(delivery.date, format: :long) rescue "â€”" %></p>

      <% if delivery.time_slot.present? %>
        <p>
          <strong>CrÃ©neau :</strong>
          <%= delivery.time_slot == "morning" ? "Matin (9h â€“ 12h30)" : "AprÃ¨s-midi (14h â€“ 19h)" %>
        </p>
      <% end %>

      <hr>

      <h3>ğŸ“ CoordonnÃ©es</h3>
      <p><strong>Email :</strong> <%= delivery.recipient_email %></p>
      <p><strong>TÃ©lÃ©phone :</strong> <%= delivery.recipient_phone %></p>

      <% if delivery.mode == "delivery" %>
        <hr>

        <h3>ğŸ  Adresse de livraison</h3>
        <p><strong>Destinataire :</strong>
          <%= [delivery.recipient_firstname, delivery.recipient_name].compact.join(" ").presence || "â€”" %>
        </p>
        <p><strong>Adresse :</strong> <%= delivery.recipient_address.presence || "â€”" %></p>
        <p><strong>Ville :</strong> <%= delivery.recipient_city.presence || "â€”" %></p>
      <% end %>

      <% if delivery.notes.present? %>
        <hr>
        <h3>ğŸ“ Notes</h3>
        <p><%= simple_format(delivery.notes) %></p>
      <% end %>

      <% if @order.products.any? { |p| p.category == "deuil" } %>
        <hr>
        <h3>ğŸ•Šï¸ CÃ©rÃ©monie (deuil)</h3>
        <p><strong>Date :</strong> <%= delivery.ceremony_date || "â€”" %></p>
        <p><strong>Heure :</strong> <%= delivery.ceremony_time || "â€”" %></p>
        <p><strong>Lieu :</strong> <%= delivery.ceremony_location.presence || "â€”" %></p>
      <% end %>

    <% else %>
      <p class="muted">âš ï¸ Aucune information de livraison enregistrÃ©e.</p>
    <% end %>
  </section>

  <!-- ğŸ› ARTICLES -->
  <section class="admin-card">
    <h2>ğŸ› Articles</h2>
    <ul class="admin-items">
      <% @order.order_items.each do |item| %>
        <li>
          <strong><%= item.product.name %></strong>
          â€” <%= item.quantity %> Ã—
          <%= number_to_currency(item.price_cents / 100.0, unit: "â‚¬") %>

          <% if item.addons.present? %>
            <br>
            <em>Options :</em> <%= item.addons.join(", ") %>
          <% end %>
        </li>
      <% end %>
    </ul>
  </section>

  <!-- âš™ï¸ GESTION -->
  <section class="admin-card">
    <h2>âš™ï¸ Gestion</h2>

    <%= form_with model: @order,
          url: backoffice_order_path(@order),
          method: :patch,
          local: true do |f| %>

      <div class="form-group">
        <%= f.label :status, "Statut" %>
        <%= f.select :status,
              ["payÃ©e", "en prÃ©paration", "prÃªte", "livrÃ©e"],
              {},
              class: "form-control" %>
      </div>

      <%= f.submit "Mettre Ã  jour",
            class: "btn btn-primary mt-2" %>
    <% end %>
  </section>

  <%= link_to "â† Retour aux commandes",
        backoffice_orders_path,
        class: "btn btn-outline" %>
</div>
