<% subtotal_cents = @order.order_items.sum { |i| i.price_cents.to_i * i.quantity.to_i } %>
<% delivery_fee_cents = @order.delivery_detail ? @order.delivery_detail.delivery_fee.to_i : 0 %>
<% total_cents = subtotal_cents + delivery_fee_cents %>

<div class="mail-wrapper">
  <div class="mail-card">

    <div class="mail-header">
      <h1>ðŸ§º Nouvelle commande <span style="opacity:.9;">#<%= @order.id %></span></h1>
      <p>
        ReÃ§ue le
        <%= l(@order.created_at.in_time_zone("Europe/Paris"), format: :long) rescue @order.created_at %>
      </p>
    </div>

    <div class="section">
      <h2 class="h2">ðŸ‘¤ Client</h2>
      <table class="kv" role="presentation" cellspacing="0" cellpadding="0">
        <tr>
          <td class="label">TÃ©lÃ©phone client</td>
          <td class="value"><%= @order.phone_number.presence || "â€”" %></td>
        </tr>
        <tr>
          <td class="label">Nom</td>
          <td class="value">
            <%= @order.full_name.presence ||
                [@delivery&.recipient_firstname, @delivery&.recipient_name].compact.join(" ").presence ||
                "Client invitÃ©" %>
          </td>
        </tr>
        <tr>
          <td class="label">Email</td>
          <td class="value"><%= @order.email.presence || @delivery&.recipient_email.presence || @user&.email || "â€”" %></td>
        </tr>
        <tr>
          <td class="label">TÃ©lÃ©phone destinataire</td>
          <td class="value"><%= @delivery&.recipient_phone.presence || "â€”" %></td>
        </tr>
      </table>
    </div>

    <% if @delivery.present? %>
      <div class="section alt">
        <h2 class="h2">ðŸ“¦ RÃ©ception</h2>
        <table class="kv" role="presentation" cellspacing="0" cellpadding="0">
          <tr>
            <td class="label">Mode</td>
            <td class="value"><%= @delivery.mode == "delivery" ? "Livraison" : "Retrait en boutique" %></td>
          </tr>
          <tr>
            <td class="label">Date</td>
            <td class="value"><%= l(@delivery.date) rescue @delivery.date %></td>
          </tr>
          <tr>
            <td class="label">CrÃ©neau</td>
            <td class="value">
              <%= case @delivery.time_slot
                  when "morning" then "Matin (9h-12h30)"
                  when "afternoon" then "AprÃ¨s-midi (14h-19h)"
                  else @delivery.time_slot.presence || "â€”"
                  end %>
            </td>
          </tr>
        </table>
      </div>
    <% end %>

    <div class="section">
      <h2 class="h2">ðŸ§¾ DÃ©tail des articles</h2>

      <table class="items" role="presentation" cellspacing="0" cellpadding="0">
        <thead>
          <tr>
            <th align="left">Article</th>
            <th align="center">QtÃ©</th>
            <th align="right">Prix</th>
          </tr>
        </thead>

        <tbody>
          <% @order.order_items.includes(:product).each do |item| %>
            <% line_total_cents = item.price_cents.to_i * item.quantity.to_i %>

            <% addons_array =
              case item.addons
              when Array then item.addons
              when String then item.addons.split(",").map(&:strip)
              else []
              end
            %>

            <% cleaned_addons = addons_array.reject { |a|
              a.to_s.downcase.include?("carte") || a.to_s.downcase.include?("ruban")
            } %>

            <tr>
              <td>
                <strong><%= item.product.name %></strong>

                <div class="muted" style="margin-top:4px;">
                  <% if item.size.present? %>
                    Taille : <%= item.size %><br>
                  <% end %>

                  <% if item.respond_to?(:color) && item.color.present? %>
                    Couleur : <%= item.color %><br>
                  <% end %>

                  <% if cleaned_addons.any? %>
                    Options : <%= cleaned_addons.join(", ") %><br>
                  <% end %>

                  <% if item.try(:addon_card) %>
                    <strong>Carte message</strong>
                    <% if item.try(:addon_card_text).present? %>
                      <div class="blockquote"><%= item.addon_card_text %></div>
                    <% else %>
                      <div>Oui (sans texte)</div>
                    <% end %>
                  <% end %>

                  <% if item.try(:addon_ruban) %>
                    <div style="margin-top:8px;">
                      <strong>Ruban</strong>
                      <% if item.try(:addon_ruban_text).present? %>
                        <div class="blockquote"><%= item.addon_ruban_text %></div>
                      <% else %>
                        <div>Oui (sans texte)</div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </td>

              <td align="center"><%= item.quantity %></td>
              <td align="right"><%= number_to_currency(line_total_cents / 100.0, unit: "â‚¬") %></td>
            </tr>
          <% end %>
        </tbody>

        <tfoot class="tfoot">
          <tr>
            <td></td>
            <td align="right" class="muted">Sous-total</td>
            <td align="right"><strong><%= number_to_currency(subtotal_cents / 100.0, unit: "â‚¬") %></strong></td>
          </tr>
          <tr>
            <td></td>
            <td align="right" class="muted">Frais de livraison</td>
            <td align="right"><strong><%= number_to_currency(delivery_fee_cents / 100.0, unit: "â‚¬") %></strong></td>
          </tr>
          <tr class="total-row">
            <td></td>
            <td align="right">Total</td>
            <td align="right"><%= number_to_currency(total_cents / 100.0, unit: "â‚¬") %></td>
          </tr>
        </tfoot>
      </table>
    </div>

  </div>
</div>
