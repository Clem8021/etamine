<div class="modal-overlay" data-controller="modal" id="product-modal">

  <!-- üîπ BACKGROUND FLUO DE L'INDEX -->
  <div class="modal-bg-blur">
    <% Product.active.order(updated_at: :desc).each do |p| %>
      <%= image_tag p.display_image, class: "bg-product-img", alt: p.name %>
    <% end %>
  </div>

  <div class="modal-content">

    <%= link_to "‚úï", products_path,
          class: "close-modal",
          data: { action: "modal#close" } %>

    <div class="product-show"
         data-controller="price color"
         data-color-colors-value="<%= @product.color_options.to_json %>">

      <!-- üñºÔ∏è COLONNE GAUCHE -->
      <div class="left-col">

        <% if @product.carousel? %>
          <div class="product-carousel"
              data-controller="carousel"
              data-carousel-interval-value="3000">

            <% @product.gallery.each_with_index do |img, index| %>
              <%= image_tag img,
                    class: "modal-product-image #{'hidden' if index.positive?}",
                    data: { carousel_target: "slide" } %>
            <% end %>
          </div>
        <% else %>
          <%= image_tag (@product.gallery.first.respond_to?(:attached?) ? url_for(@product.gallery.first) : @product.gallery.first),
                class: "modal-product-image" %>
        <% end %>

        <h2 class="product-title"><%= @product.name %></h2>

        <!-- Prix de base requis par price_controller -->
        <p class="product-price"
           data-price-target="basePrice"
           data-base="<%= @product.price_cents %>">
          <%= number_to_currency(@product.price_euros, unit: "‚Ç¨") %>
        </p>
      </div>

      <!-- üßæ COLONNE DROITE -->
      <div class="form-col">
        <%= form_with url: order_order_items_path(@order),
              scope: :order_item,
              local: true,
              id: "add-to-cart-form",
              data: { turbo: false } do |f| %>

          <%= f.hidden_field :product_id, value: @product.id %>

          <!-- üé® COULEUR -->
          <% if @product.color_options.present? %>
            <label>Couleur <span class="required">*</span></label>

            <%= f.select :color,
              options_for_select(
                @product.color_options.is_a?(Hash) ?
                  @product.color_options.keys :
                  @product.color_options.split(",").map(&:strip)
              ),
              { prompt: "Choisissez une couleur" },
              class: "form-control",
              required: true,
              data: {
                action: "change->color#updateImage",
                color_target: "select"
              } %>
          <% end %>

          <!-- üíê BOUQUETS / COMPOSITIONS / NO√ãL : PRIX PERSONNALISABLE -->
          <% if @product.customizable_price? &&
                @product.category != "roses" &&
                @product.price_options.present? %>

            <label>Budget <span class="required">*</span></label>

            <%= f.select :size,
              options_for_select(
                @product.price_options.map { |label, cents|
                  [label, label, { "data-price": cents }]
                }
              ),
              { prompt: "Choisissez un budget" },
              class: "form-control",
              required: true,
              data: {
                action: "change->price#update",
                price_target: "budgetSelect"
              } %>

          <% end %>

          <% if @product.category == "bouquets" %>
            <div class="addon-option" style="margin-top:0.75rem;">
              <%= check_box_tag "order_item[addons][]",
                    "Bouquet bulle (+4,50‚Ç¨)",
                    false,
                    data: {
                      action: "change->price#update",
                      price_value: 450
                    } %>
              <span><strong>Bouquet bulle d‚Äôeau (+4,50 ‚Ç¨)</strong></span>
            </div>
          <% end %>
          <!-- üåπ ROSES -->
          <% if @product.category == "roses" && @product.price_options.present? %>
            <label>
              Nombre de roses <span class="required">*</span>
            </label>

            <%= f.select :size,
              options_for_select(
                @product.price_options.map { |label, cents|
                  ["#{label} ‚Äî #{number_to_currency(cents / 100.0, unit: "‚Ç¨")}",
                   label,
                   { "data-price": cents }]
                }
              ),
              { prompt: "Choisissez une quantit√©" },
              class: "form-control",
              required: true,
              data: {
                action: "change->price#update",
                price_target: "budgetSelect"
              } %>

            <label class="mt-2">Options (facultatif)</label>

            <div class="addon-option">
              <%= check_box_tag "order_item[addons][]",
                    "Gypsophile (+2‚Ç¨)",
                    false,
                    data: { action: "change->price#update", price_value: 200 } %>
              <span>Branche de gypsophile (+2‚Ç¨)</span>
            </div>

            <div class="addon-option">
              <%= check_box_tag "order_item[addons][]",
                    "Eucalyptus (+3,50‚Ç¨)",
                    false,
                    data: { action: "change->price#update", price_value: 350 } %>
              <span>Feuillage eucalyptus (+3,50‚Ç¨)</span>
            </div>
          <% end %>

          <% if @product.category == "deuil" && @product.price_options.present? && !@product.customizable_price? %>
            <label>Taille <span class="required">*</span></label>

            <%= f.select :size,
              options_for_select(
                @product.price_options.map { |label, cents|
                  ["#{label} ‚Äî #{number_to_currency(cents / 100.0, unit: "‚Ç¨")}",
                  label,
                  { "data-price": cents }]
                }
              ),
              { prompt: "Choisissez une taille" },
              class: "form-control",
              required: true,
              data: {
                action: "change->price#update",
                price_target: "budgetSelect"
              } %>
          <% end %>
          <!-- üéóÔ∏è DEUIL : RUBAN -->
          <% if @product.category == "deuil" %>
            <div data-controller="addon" class="mt-2">

              <%= check_box_tag "order_item[addons][]",
                    "Ruban deuil",
                    false,
                    data: {
                      action: "change->addon#toggleCard price#update",
                      price_value: 700
                    } %>
              <label>Ruban deuil (+7‚Ç¨)</label>

              <div data-addon-target="cardFields" class="hidden">
                <%= f.text_area :addon_ruban_text,
                      placeholder: "Texte du ruban (35 caract√®res max)",
                      maxlength: 35,
                      class: "form-control" %>
              </div>
            </div>
          <% end %>

          <!-- üíå CARTE MESSAGE -->
          <% if @product.category.in?(%w[bouquets compositions roses plantes noel deuil]) %>
            <div data-controller="addon" class="mt-2">
              <%= check_box_tag "order_item[addons][]",
                    "Carte message",
                    false,
                    data: {
                      action: "change->addon#toggleCard price#update",
                      price_value: 150
                    } %>

              <label>Carte message (+1,50‚Ç¨)</label>

              <div data-addon-target="cardFields" class="hidden">
                <% card_names = @product.message_cards.order(:name).pluck(:name) %>

                <% if card_names.any? %>
                  <%= f.select :addon_card_type,
                        options_for_select(card_names, f.object.addon_card_type),
                        { prompt: "Choisissez un message" },
                        class: "form-control" %>
                <% else %>
                  <p class="muted">Aucune carte message configur√©e pour ce produit.</p>
                <% end %>

                <%= f.text_area :addon_card_text,
                      placeholder: "Votre message (100 caract√®res max)",
                      maxlength: 100,
                      class: "form-control" %>
              </div>
          <% end %>

          <!-- üî¢ QUANTIT√â -->
          <label>Quantit√©</label>
          <%= f.number_field :quantity,
            value: 1,
            min: 1,
            class: "form-control",
            data: {
              action: "input->price#update",
              price_target: "quantity"
            } %>

          <!-- üí∞ TOTAL -->
          <p class="total-price-box">
            <strong>Total :</strong>
            <span data-price-target="totalPrice"></span>
          </p>

          <!-- üõí AJOUT PANIER -->
          <div class="fixed-button">
            <%= f.submit "Ajouter au panier", class: "btn btn-primary" %>
          </div>

          <div id="post-add-to-cart-actions" class="modal-actions hidden">
            <%= link_to "Voir mon panier",
                  checkout_order_path(current_order),
                  class: "btn btn-secondary" %>

            <%= link_to "Retour √† la boutique",
                  boutique_path(category: session[:last_category] || "bouquets"),
                  class: "btn btn-outline" %>
          </div>

        <% end %> <!-- FIN DU form_with -->

      <!-- üå∏ INFO BOX -->
      <div class="floral-info-box">
        <%= image_tag "fleur.png", class: "floral-icon", alt: "" %>
        <p>
          Les photos sont <strong>non contractuelles</strong>.
          Les fleurs peuvent varier selon les saisons.<br>
          <strong>
            <%= link_to "Contactez-nous", contact_path, class: "floral-contact-link" %>
          </strong>
          pour toute demande sp√©cifique.
        </p>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("turbo:load", () => {
  const modal = document.getElementById("product-modal");
  const closeBtn = document.querySelector(".close-modal");
  const form = document.getElementById("add-to-cart-form");
  const postActions = document.getElementById("post-add-to-cart-actions");
  const cartCounter = document.getElementById("cart-counter");

  // Fermer modale
  closeBtn.addEventListener("click", (e) => {
    e.preventDefault();
    window.location.href = "<%= products_path %>";
  });

  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      window.location.href = "<%= products_path %>";
    }
  });

  // ‚úÖ Mettre √† jour prix quand on change le nombre de roses
  const qtySelect = document.getElementById("quantity_select");
  const priceEl = document.querySelector(".product-price");

  if (qtySelect && priceEl) {
    qtySelect.addEventListener("change", (e) => {
      const option = e.target.selectedOptions[0];
      if (option && option.textContent.includes("‚Ç¨")) {
        priceEl.textContent = option.textContent.split("‚Äî")[1].trim();
      }
    });
  }

  // ‚úÖ Envoi AJAX du formulaire
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      fetch(form.action, {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Accept": "application/json"
        }
      })
      .then(response => {
        if (!response.ok) throw new Error("HTTP error " + response.status);
        return response.json();
      })
      .then(data => {
        if (data.success) {
          postActions.classList.remove("hidden");
          if (cartCounter) cartCounter.textContent = data.cart_item_count;
          // ‚úÖ rien d‚Äôautre, pas d‚Äôalert
        }
        // ‚ùå on ne met pas de else pour √©viter un alert
      })
      .catch((err) => {
        console.error(err); // log silencieux dans la console
      });
    });
  }
});
document.addEventListener("turbo:load", () => {
  const form = document.getElementById("add-to-cart-form");
  const postActions = document.getElementById("post-add-to-cart-actions");

  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault(); // ‚õî emp√™che le rechargement
      setTimeout(() => {
        alert("‚úÖ Produit ajout√© au panier !");
        if (postActions) postActions.classList.remove("hidden");
      }, 200);
    });
  }
});
</script>
