<div class="modal-overlay" data-controller="modal" id="product-modal">
  <div class="modal-content">

    <%= link_to "‚úï", products_path,
          class: "close-modal",
          data: { action: "modal#close" } %>

    <div class="product-show"
         data-controller="price color"
         data-color-colors-value="<%= @product.color_options.to_json %>">

      <!-- üñºÔ∏è COLONNE GAUCHE -->
    <div class="left-col">

      <% if @product.name == "Composition Jacinthes No√´l" %>
        <!-- üéÑ CARROUSEL JACINTHES NO√ãL -->
        <div class="jacinthes-carousel"
            data-controller="carousel"
            data-carousel-interval-value="3000">

          <%= image_tag "jacinthes_noel_1.jpg",
                class: "modal-product-image",
                data: { carousel_target: "slide" } %>

          <%= image_tag "jacinthes_noel_2.jpg",
                class: "modal-product-image hidden",
                data: { carousel_target: "slide" } %>

          <%= image_tag "jacinthes_noel_3.jpg",
                class: "modal-product-image hidden",
                data: { carousel_target: "slide" } %>
        </div>
      <% else %>
        <!-- üñºÔ∏è IMAGE CLASSIQUE -->
        <%= image_tag @product.display_image,
              alt: @product.name,
              class: "modal-product-image",
              data: { color_target: "mainImage" } %>
      <% end %>

      <h2 class="product-title"><%= @product.name %></h2>
    </div>

      <!-- üßæ COLONNE DROITE -->
      <div class="form-col">
        <%= form_with url: order_order_items_path(@order),
              scope: :order_item,
              local: true,
              id: "add-to-cart-form",
              data: { turbo: false } do |f| %>

          <%= f.hidden_field :product_id, value: @product.id %>

          <!-- üé® COULEUR (OBLIGATOIRE) -->
          <% if @product.color_options.present? %>
            <label>Couleur <span style="color:#b96b75">*</span></label>

            <%= f.select :color,
                  options_for_select(
                    @product.color_options.is_a?(Hash) ?
                      @product.color_options.keys :
                      @product.color_options.split(",").map(&:strip)
                  ),
                  { prompt: "Choisissez une couleur" },
                  class: "form-control",
                  required: true,
                  data: {
                    action: "change->color#updateImage",
                    color_target: "select"
                  } %>
          <% end %>

          <!-- üåπ ROSES : NOMBRE -->
          <% if @product.category == "roses" && @product.price_options.present? %>
            <label>Nombre de roses</label>

            <%= f.select :size,
                  options_for_select(
                    @product.price_options.map { |label, cents|
                      ["#{label} ‚Äî #{number_to_currency(cents / 100.0, unit: "‚Ç¨")}",
                       label,
                       { "data-price": cents }]
                    }
                  ),
                  { prompt: "Choisissez une quantit√©" },
                  class: "form-control",
                  data: {
                    action: "change->price#update",
                    price_target: "budgetSelect"
                  } %>

            <!-- üåø OPTIONS ROSES -->
            <label style="margin-top:0.75rem;">Options (facultatif)</label>

            <div class="addon-option">
              <%= check_box_tag "order_item[addons][]",
                    "Gypsophile (+2‚Ç¨)",
                    false,
                    data: {
                      action: "change->price#update",
                      price_value: 200
                    } %>
              <span>Branche de gypsophile (+2‚Ç¨)</span>
            </div>

            <div class="addon-option">
              <%= check_box_tag "order_item[addons][]",
                    "Eucalyptus (+3,50‚Ç¨)",
                    false,
                    data: {
                      action: "change->price#update",
                      price_value: 350
                    } %>
              <span>Feuillage eucalyptus (+3,50‚Ç¨)</span>
            </div>
          <% end %>

          <!-- üíå CARTE MESSAGE -->
          <% if @product.category.in?(%w[compositions roses plantes noel deuil]) %>
            <div data-controller="addon" style="margin-top:1rem;">
              <label>Carte message (+1,50‚Ç¨)</label>

              <%= f.check_box :addon_card,
                    { data: { action: "change->addon#toggleCard price#update", price_value: 150 } },
                    "true", "false" %>

              <div data-addon-target="cardFields" class="hidden">
                <% messages = [
                  "Joyeux anniversaire",
                  "Heureux anniversaire",
                  "Heureux mariage",
                  "F√©licitations",
                  "Bapt√™me",
                  "Bonne f√™te",
                  "Je t'aime",
                  "Plaisir d'offrir",
                  "Merci"
                ] %>

                <% messages = ["Joyeux No√´l", "Joyeuses F√™tes"] + messages if @product.category == "noel" %>
                <% messages = ["Sinc√®res condol√©ances"] + messages if @product.category == "deuil" %>

                <%= f.select :addon_card_type,
                      options_for_select(messages),
                      { prompt: "Choisissez un message" },
                      class: "form-control" %>

                <%= f.text_area :addon_card_text,
                      placeholder: "Votre message (100 caract√®res max)",
                      maxlength: 100,
                      class: "form-control" %>
              </div>
            </div>
          <% end %>

          <!-- üî¢ QUANTIT√â -->
          <label>Quantit√©</label>
          <%= f.number_field :quantity,
                value: 1,
                min: 1,
                class: "form-control",
                data: {
                  action: "input->price#update",
                  price_target: "quantity"
                } %>

          <!-- üí∞ TOTAL -->
          <p class="total-price-box">
            <strong>Total :</strong>
            <span data-price-target="totalPrice"></span>
          </p>

          <!-- üõí AJOUT PANIER -->
          <div class="fixed-button">
            <%= f.submit "Ajouter au panier",
                  class: "btn btn-primary" %>
          </div>

        <% end %>

        <!-- ‚úÖ ACTIONS APR√àS AJOUT -->
        <div id="post-add-to-cart-actions" class="modal-actions hidden">
          <%= link_to "Voir mon panier",
                checkout_order_path(current_order),
                class: "btn btn-secondary" %>

          <%= link_to "Retour √† la boutique",
                products_path,
                class: "btn btn-outline" %>
        </div>
      </div>

      <!-- üå∏ INFO BOX ‚Äì PLEINE LARGEUR -->
      <div class="floral-info-box">
        <%= image_tag "fleur.png", class: "floral-icon", alt: "" %>
        <p>
          Les photos sont <strong>non contractuelles</strong>.
          Les fleurs peuvent varier <strong>selon les saisons</strong>.
          <br>
          <strong>
            <%= link_to "Contactez-nous",
                  contact_path,
                  class: "floral-contact-link" %>
          </strong>
          pour toute demande sp√©cifique.
        </p>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("turbo:load", () => {
  const modal = document.getElementById("product-modal");
  const closeBtn = document.querySelector(".close-modal");
  const form = document.getElementById("add-to-cart-form");
  const postActions = document.getElementById("post-add-to-cart-actions");
  const cartCounter = document.getElementById("cart-counter");

  // Fermer modale
  closeBtn.addEventListener("click", (e) => {
    e.preventDefault();
    window.location.href = "<%= products_path %>";
  });

  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      window.location.href = "<%= products_path %>";
    }
  });

  // ‚úÖ Mettre √† jour prix quand on change le nombre de roses
  const qtySelect = document.getElementById("quantity_select");
  const priceEl = document.querySelector(".product-price");

  if (qtySelect && priceEl) {
    qtySelect.addEventListener("change", (e) => {
      const option = e.target.selectedOptions[0];
      if (option && option.textContent.includes("‚Ç¨")) {
        priceEl.textContent = option.textContent.split("‚Äî")[1].trim();
      }
    });
  }

  // ‚úÖ Envoi AJAX du formulaire
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      fetch(form.action, {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Accept": "application/json"
        }
      })
      .then(response => {
        if (!response.ok) throw new Error("HTTP error " + response.status);
        return response.json();
      })
      .then(data => {
        if (data.success) {
          postActions.classList.remove("hidden");
          if (cartCounter) cartCounter.textContent = data.cart_item_count;
          // ‚úÖ rien d‚Äôautre, pas d‚Äôalert
        }
        // ‚ùå on ne met pas de else pour √©viter un alert
      })
      .catch((err) => {
        console.error(err); // log silencieux dans la console
      });
    });
  }
});
document.addEventListener("turbo:load", () => {
  const form = document.getElementById("add-to-cart-form");
  const postActions = document.getElementById("post-add-to-cart-actions");

  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault(); // ‚õî emp√™che le rechargement
      setTimeout(() => {
        alert("‚úÖ Produit ajout√© au panier !");
        if (postActions) postActions.classList.remove("hidden");
      }, 200);
    });
  }
});
</script>
