<%= render "shared/navbar" %>

<% unless @ready_for_payment %>
  <!-- === Barre de progression (√©tapes 1/2/3) === -->
  <div class="checkout-progress">
    <div class="step active">
      <span class="circle">1</span>
      <span class="label">Panier</span>
    </div>

    <div class="connector"></div>

    <div class="step">
      <span class="circle">2</span>
      <span class="label">Livraison</span>
    </div>

    <div class="connector"></div>

    <div class="step">
      <span class="circle">3</span>
      <span class="label">Paiement</span>
    </div>
  </div>
<% end %>

<div class="checkout-container">
  <h2><%= @ready_for_payment ? "üßæ R√©capitulatif avant paiement" : "üõí Votre panier" %></h2>

  <% if @order.order_items.any? %>
    <!-- === R√©capitulatif des articles === -->
    <div class="order-summary">
      <ul class="order-items-list">
        <% @order.order_items.each do |item| %>
          <li class="order-item">
            <%= image_tag item.product.display_image, alt: item.product.name, class: "product-thumb" %>

            <div class="item-details">
              <p class="item-name"><%= item.product.name %></p>

              <p class="item-meta">
                <% if item.color.present? %>
                  <strong>Couleur :</strong> <%= item.color %><br>
                <% end %>

                <% if item.size.present? %>
                  <strong>Taille :</strong> <%= item.size %><br>
                <% end %>

                <% if item.addons.present? %>
                  <strong>Options :</strong><br>
                  <ul class="addons-list">
                    <% item.addons.each do |addon| %>
                      <li>‚Ä¢ <%= addon %></li>
                    <% end %>
                  </ul>
                <% end %>

                <% if item.addon_card_type.present? %>
                  <strong>Carte message :</strong> <%= item.addon_card_type %><br>
                <% end %>

                <% if item.addon_card_text.present? %>
                  <em>‚Äú<%= item.addon_card_text %>‚Äù</em><br>
                <% end %>

                <% if item.addon_ruban_text.present? %>
                  <strong>Ruban :</strong> <em>‚Äú<%= item.addon_ruban_text %>‚Äù</em><br>
                <% end %>
              </p>

              <% unless @ready_for_payment %>
                <div class="quantity-form">
                  <%= form_with model: [@order, item],
                                url: order_order_item_path(@order, item),
                                method: :patch,
                                local: true,
                                class: "inline-form" do |f| %>
                    <label>Quantit√© :</label>
                    <%= f.number_field :quantity, value: item.quantity, min: 1, class: "quantity-input" %>
                    <%= f.submit "‚úî", class: "btn-small" %>
                  <% end %>
                </div>

                <div class="item-actions">
                  <%= button_to "‚ùå Supprimer",
                    order_order_item_path(@order, item),
                    method: :delete,
                    class: "btn-remove",
                    data: {
                      controller: "soft-confirm",
                      action: "click->soft-confirm#open",
                      soft_confirm_title_value: "Supprimer l‚Äôarticle ?",
                      soft_confirm_message_value: "¬´ #{item.product.name} ¬ª sera retir√© de votre panier.",
                      soft_confirm_confirm_label_value: "Oui, supprimer",
                      soft_confirm_cancel_label_value: "Annuler"
                    } %>
                                  </div>
              <% end %>
            </div>
          </li>
        <% end %>
      </ul>

      <!-- === Totaux === -->
      <div class="order-prices">
        <p>Sous-total : <%= number_to_currency(@order.total_price, unit: "‚Ç¨") %></p>
        <% if @order.delivery_detail&.mode == "delivery" %>
          <p>Frais de livraison : <%= number_to_currency(@order.delivery_fee_cents / 100.0, unit: "‚Ç¨") %></p>
        <% end %>
        <p class="order-total">
          Total TTC : <%= number_to_currency(@order.total_due, unit: "‚Ç¨") %>
        </p>
      </div>
    </div>

    <!-- === √âtape 3 : r√©capitulatif livraison === -->
  <% if @ready_for_payment && @order.delivery_detail.present? %>
    <div class="delivery-summary">
      <h3>üöö D√©tails de livraison</h3>

      <% if @order.delivery_detail.mode == "delivery" %>
        <p><strong>Mode :</strong> Livraison √† domicile</p>
        <p><strong>Nom :</strong> <%= @order.delivery_detail.recipient_firstname %> <%= @order.delivery_detail.recipient_name %></p>
        <p><strong>Adresse :</strong> <%= @order.delivery_detail.recipient_address %>, <%= @order.delivery_detail.recipient_zip %> <%= @order.delivery_detail.recipient_city %></p>
        <p><strong>T√©l√©phone :</strong> <%= @order.delivery_detail.recipient_phone %></p>

        <% if @order.delivery_detail.date.present? %>
          <p><strong>Date :</strong> <%= @order.delivery_detail.date.strftime("%d/%m/%Y") %></p>
        <% end %>

        <% if @order.delivery_detail.time_slot.present? %>
          <p><strong>Cr√©neau horaire :</strong>
            <%= case @order.delivery_detail.time_slot
                when "morning" then "üåû Matin (9h-12h30)"
                when "afternoon" then "üåÜ Apr√®s-midi (14h-19h)"
                else @order.delivery_detail.time_slot
                end %>
          </p>
        <% end %>

        <% if @order.delivery_detail.notes.present? %>
          <p><strong>Remarques :</strong> <%= @order.delivery_detail.notes %></p>
        <% end %>

      <% else %>
        <p><strong>Mode :</strong> Retrait en boutique</p>

        <% if @order.delivery_detail.date.present? %>
          <p><strong>Date :</strong> <%= @order.delivery_detail.date.strftime("%d/%m/%Y") %></p>
        <% end %>

        <% if @order.delivery_detail.time_slot.present? %>
          <p><strong>Cr√©neau :</strong>
            <%= case @order.delivery_detail.time_slot
                when "morning" then "üåû Matin (9h-12h30)"
                when "afternoon" then "üåÜ Apr√®s-midi (14h-19h)"
                else @order.delivery_detail.time_slot
                end %>
          </p>
        <% end %>
      <% end %>

      <%= link_to "‚úèÔ∏è Modifier", edit_order_delivery_detail_path(@order, @order.delivery_detail), class: "btn btn-secondary" %>
    </div>
  <% end %>

    <!-- === √âtape 2 ou 3 === -->
        <!-- === √âtape 2 ou 3 === -->
    <% unless @ready_for_payment %>
      <div class="checkout-actions">
        <%= link_to "üìù Renseigner mes informations de livraison",
                    new_order_delivery_detail_path(@order),
                    class: "btn btn-secondary" %>

        <%= link_to "üõç Revenir √† la boutique", boutique_path, class: "btn btn-secondary" %>
      </div>
    <% else %>
      <div class="payment-button-wrapper" data-controller="loading">
        <%= button_to "üí≥ Proc√©der au paiement s√©curis√©",
                      confirm_order_path(@order),
                      method: :post,
                      class: "btn btn-primary",
                      data: { turbo: false, action: "loading#activate" } %>

        <!-- üîô Bouton retour boutique -->
        <div class="back-to-shop">
          <%= link_to "‚Üê Revenir √† la boutique", boutique_path, class: "btn btn-secondary" %>
        </div>
      </div>
    <% end %>
  <% else %>
    <!-- === Panier vide === -->
    <div class="empty-cart-notice fade-in">
      <h3>Votre panier est vide üïäÔ∏è</h3>
      <p>Ajoutez un bouquet ou une plante pour commencer votre commande.</p>
      <%= link_to "Retour √† la boutique", boutique_path, class: "btn-primary" %>
    </div>
  <% end %>
</div>
