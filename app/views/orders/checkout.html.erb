<div class="checkout-container">
  <h2>🧾 Récapitulatif de votre commande</h2>

  <!-- Infos de livraison/retrait -->
  <div class="delivery-summary">
    <h3>Informations de livraison / retrait</h3>

    <% if @order.delivery_detail.present? %>
      <p><strong>Mode :</strong> <%= @order.delivery_detail.mode == "delivery" ? "Livraison" : "Retrait en boutique" %></p>
      <p><strong>Date :</strong> <%= l(@order.delivery_detail.date, format: :long) %></p>
      <p><strong>Créneau :</strong>
        <%= case @order.delivery_detail.time_slot
            when "morning" then "Matin (9h-12h30)"
            when "afternoon" then "Après-midi (14h-19h)"
            else @order.delivery_detail.time_slot
            end %>
      </p>

      <% if @order.products.any? { |p| p.category == "deuil" } %>
        <div class="info-deuil">
          <h4>🕊️ Informations pour la cérémonie</h4>
          <ul>
            <li><strong>Date et heure de la cérémonie</strong></li>
            <li><strong>Nom de l’église ou du cimetière</strong></li>
          </ul>
          <p class="warning">⚠️ Les fleurs peuvent varier selon les saisons. Photos non contractuelles.</p>
        </div>
      <% end %>

      <% if @order.delivery_detail.mode == "delivery" %>
        <p><strong>Destinataire :</strong> <%= @order.delivery_detail.recipient_name %> <%= @order.delivery_detail.recipient_firstname %></p>
        <p><strong>Adresse :</strong> <%= @order.delivery_detail.recipient_address %>, <%= @order.delivery_detail.recipient_zip %> <%= @order.delivery_detail.recipient_city %></p>
        <p><strong>Téléphone :</strong> <%= @order.delivery_detail.recipient_phone %></p>

        <!-- Règles spécifiques livraison -->
        <% if @order.delivery_detail.date == Date.today %>
          <p class="warning">⚠️ Livraison impossible le jour J en ligne. Merci de contacter le magasin.</p>
        <% end %>

        <% if @order.delivery_detail.recipient_city == "Flesselles" && @order.total_price >= 20 %>
          <p class="info">🚚 Livraison gratuite sur Flesselles (≥ 20€ d’achats)</p>
        <% elsif @order.delivery_detail.recipient_city != "Flesselles" %>
          <p class="info">🚚 Frais de livraison fixes : 3,50€</p>
        <% end %>
      <% else %>
        <!-- Règles spécifiques retrait -->
        <p class="info">🕑 Retrait en magasin : délai minimum de 2 heures.</p>
      <% end %>

      <p><strong>Notes :</strong> <%= @order.delivery_detail.notes.presence || "Aucune" %></p>

      <!-- Bouton modifier -->
      <div class="edit-delivery">
        <%= link_to "✏️ Modifier mes informations de livraison/retrait",
                    edit_order_delivery_detail_path(@order),
                    class: "btn btn-outline-primary" %>
      </div>

    <% else %>
      <p>⚠️ Aucune information de livraison/retrait fournie.</p>
      <%= link_to "Compléter mes informations", new_order_delivery_detail_path(@order), class: "btn btn-secondary" %>
    <% end %>
  </div>

  <!-- Détail des articles -->
  <div class="order-summary">
    <h3>Vos articles</h3>
    <ul class="order-items-list">
      <% @order.order_items.each do |item| %>
        <li class="order-item">
          <div class="item-image">
            <%= image_tag item.product.image_url, alt: item.product.name, class: "product-thumb" %>
          </div>
          <div class="item-details">
            <p class="item-name"><%= item.product.name %></p>
            <p class="item-meta">
              <%= item.quantity %> × <%= number_to_currency(item.price_cents / 100.0, unit: "€") %>
              <% if item.color.present? %> | <%= item.color %><% end %>
              <% if item.size.present? %> | <%= item.size %><% end %>
            </p>
            <% if item.addons.present? %>
              <p>Options : <%= item.addons.join(", ") %></p>
            <% end %>
          </div>
        </li>
      <% end %>
    </ul>
    <p class="order-total"><strong>Total :</strong> <%= number_to_currency(@order.total_price_cents / 100.0, unit: "€") %></p>
  </div>

  <!-- Boutons d'action -->
  <div class="checkout-actions">
    <%= link_to "← Retour à la boutique", boutique_path, class: "btn btn-secondary" %>

    <!-- Bouton Stripe -->
    <%= button_to "💳 Paiement sécurisé",
      confirm_order_path(@order),
      method: :post,
      class: "btn btn-primary",
      data: { turbo: false } %>
  </div>
</div>
